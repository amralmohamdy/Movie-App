<div class="page-container p-4 md:p-8">
  @if (isLoadingAll) {
  <app-skeleton type="details" />
  } @else if (hasError) {
  <div class="error text-error text-lg text-center mt-8">❌ Error: {{ hasError.message }}</div>
  } @else if (film) {
  <div
    class="details-card flex flex-col md:flex-row gap-8 p-6 md:p-10 bg-base-100 dark:bg-base-200 rounded-3xl shadow-2xl transition-all"
  >
    <!-- Left: Poster -->
    <div class="left flex-shrink-0 w-full md:w-1/3 max-w-sm mx-auto md:mx-0">
      <img
        [src]="film.poster_path ? imageBase + film.poster_path : 'imgnotfound.png'"
        [alt]="film.title"
        class="poster w-full rounded-2xl shadow-xl transition-transform hover:scale-105"
      />
    </div>

    <!-- Right: Details -->
    <div class="right flex-1 flex flex-col">
      <!-- Header -->
      <div
        class="header-row flex flex-col md:flex-row justify-between items-start md:items-center gap-2 md:gap-0"
      >
        <h1 class="title text-3xl md:text-4xl font-extrabold">{{ film.title }}</h1>
        <button
          class="btn btn-circle btn-lg shadow-lg backdrop-blur-sm transition-all border-2 border-base-200 dark:border-base-100 hover:bg-error hover:text-white"
          [class.bg-error]="isInWishlist()"
          [class.text-white]="isInWishlist()"
          aria-label="Favorite button"
          (click)="toggleWishlist()"
        >
          <i
            [class.fa-heart-crack]="isInWishlist()"
            [class.fa-heart]="!isInWishlist()"
            class="fa-solid"
          ></i>
        </button>
      </div>

      <!-- Tagline -->
      <p class="tagline text-base text-muted mt-1 italic" *ngIf="film.tagline">
        "{{ film.tagline }}"
      </p>

      <!-- Meta info -->
      <div
        class="meta flex flex-wrap gap-4 mt-4 items-center text-sm text-gray-500 dark:text-gray-300"
      >
        <!-- Release Date -->
        <span class="flex items-center gap-1 my-text cursor-default">
          <i class="fas fa-calendar-alt"></i>
          {{ film.release_date | date : 'mediumDate' }}
        </span>

        <!-- Runtime -->

        @if(film.runtime){
        <div class="tooltip">
          <div class="tooltip-content">
            <div class="text-white-400">{{'details.duration' | translate}}</div>
          </div>
          <span class="flex items-center gap-1 my-text cursor-default" data-tip="duration">
            <i class="fas fa-clock"></i>
            {{ formatRuntime(film.runtime) }}
          </span>
        </div>
        }
      </div>

      <!-- Rating stars -->
      <div class="flex items-center gap-3 mt-3">
        <!-- Stars -->
        @if(film.vote_average!= null){
        <div class="stars flex items-center gap-1">
          @for(i of [1,2,3,4,5]; track $index) {
          <i
            class="fa-solid fa-star w-5 h-5"
            [ngClass]="{
              'text-yellow-400': i < math(film.vote_average),
              'text-gray-300 dark:text-gray-500': i >= math(film.vote_average)
            }"
          >
          </i>
          }
        </div>
        }

        <!-- Numeric Rating -->
        <span class="text-sm font-semibold">{{ film.vote_average / 2 | number : '1.1-1' }}/5</span>

        <!-- Votes Count -->
        <span class="text-sm opacity-70">votes: {{ film.vote_count | number }}</span>
      </div>

      <!-- Overview -->
      <div class="mt-6">
        <h3 class="text-lg font-semibold mb-2 my-text">{{'details.overview' | translate}}</h3>
        <p
          class="p-4 rounded-xl bg-base-200/60 dark:bg-base-300/40 text-base-content text-sm md:text-base leading-relaxed shadow-sm border border-base-300/40 backdrop-blur-sm"
        >
          {{ film.overview }}
        </p>
      </div>
      <!-- Genres -->
      <div class="genres mt-4">
        <h3 class="text-lg font-semibold mb-2 my-text">{{'details.genres' | translate}}</h3>
        <div class="flex flex-wrap gap-2">
          @for (g of film.genres; track $index) {
          <a class="btn btn-outline btn-warning" [routerLink]="'/genres/' + g.id">{{
            $any(g).name
          }}</a>
          }
        </div>
      </div>
      <div class="divider mb-0"></div>
      <!-- Extras -->
      <div class="extras mt-5 grid grid-cols-1 sm:grid-cols-2 gap-2 text-sm">
        @if (film.spoken_languages.length) {
        <div>
          <strong>{{'details.language' | translate}}:</strong>
          @for(i of film.spoken_languages; track $index; let ix = $index ){
          {{ i.english_name + ' (' + i.name + ')' }}
          @if(ix+1 < film.spoken_languages.length ){,}@else{.} }
        </div>
        } @if (film.production_companies.length > 0) {
        <div class="flex flex-wrap items-center">
          <strong>Production:</strong>
          <div class="tooltip w-25">
            <div class="tooltip-content">
              <div class="text-white-400">{{ film.production_companies[0].name }}</div>
            </div>
            <img [src]="imageBase + film.production_companies[0].logo_path" class="mx-2" />
          </div>
        </div>
        } @if (film.budget) {
        <div><strong>{{'details.budget' | translate}}:</strong> {{ film.budget | currency : 'USD' : 'symbol' }}</div>
        } @if (film.revenue) {
        <div><strong>{{'details.revenue' | translate}}:</strong> {{ film.revenue | currency : 'USD' : 'symbol' }}</div>
        }
      </div>

      <!-- Buttons -->
      <div class="buttons flex flex-wrap gap-3 mt-6">
        @if (film.homepage) {
        <a
          [href]="film.homepage"
          class="btn btn-primary transition-transform hover:scale-105"
          target="_blank"
          rel="noopener"
          >{{'details.website' | translate}}</a
        >
        } @if (trailerKey) {
        <a
          class="btn btn-outline flex items-center gap-2 transition-transform hover:scale-105"
          (click)="openModal(trailerKey); $event.preventDefault(); trailerModal.showModal()"
        >
          <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
            <path d="M4 4l12 6-12 6V4z" />
          </svg>
          {{'details.playTrailer' | translate}}
        </a>

        <dialog #trailerModal class="modal" (click)="closeModal()">
          <div class="modal-box max-w-3xl bg-base-200">
            <form method="dialog">
              <button
                class="btn btn-sm btn-circle btn-ghost absolute right-3 top-3"
                (click)="closeModal()"
              >
                ✕
              </button>
            </form>
            <div class="aspect-video mt-4 rounded-xl overflow-hidden">
              <iframe
                width="100%"
                height="100%"
                [src]="youtubeUrl | safe"
                frameborder="0"
                allow="autoplay; encrypted-media"
                allowfullscreen
              ></iframe>
            </div>
          </div>
        </dialog>
        }
      </div>
    </div>
  </div>

  @if (recommendations.length > 0) {
  <div class="divider mt-10"></div>
  <div class="recommendations">
    <h3 class="text-xl font-semibold mb-3">{{'details.recommendations' | translate}}</h3>
    <div class="rec-row grid grid-cols-2 sm:grid-cols-3 md:grid-cols-6 gap-4">
      @for (r of recommendations; track r.id) {
      <app-item [film]="r" />
      }
    </div>
  </div>
  } }
</div>

<!-- Toast Notification -->
<div *ngIf="showToast()" class="fixed top-4 right-4 z-50 transition-all duration-300">
  <div
    class="alert shadow-lg rounded-xl border border-base-300 dark:border-base-100 relative overflow-hidden"
    [ngClass]="{
      'bg-success text-white': toastType() === 'success',
      'bg-error text-white': toastType() === 'error',
      'bg-info text-white': toastType() === 'info'
    }"
  >
    <span>{{ toastMessage() }}</span>

    <!-- Progress bar -->
    <div
      class="absolute top-0 left-0 h-1"
      [style.width.%]="toastProgress() * 100"
      [ngClass]="{
        'bg-success/70': toastType() === 'success',
        'bg-error/70': toastType() === 'error',
        'bg-info/70': toastType() === 'info'
      }"
    ></div>
  </div>
</div>